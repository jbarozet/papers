# CSR1000v SD-WAN Bootstrap Configuration

<br>

## Bootstrap File

Upon bootup, CSR1000v SD-WAN XE router will search bootflash: or usbflash: for filename ciscosdwan_cloud_init.cfg (make sure you use the exact same name). This file is the cloud-init file generated by vManage.

In a KVM (or OpenStack) context, CSR1000v/C8000v only supports file-based **config-drive** configuration, which is to say CSR1000v/C8000v does not generally support metadata or user_data as Day0 delivery mechanisms.

So the workflow is to generate the bootstrap config file (from vManage or linux tools), then create an iso image that contains this file. This will be mounted as a cdrom and used by cloud-init to bootstrap de VM.

The SD-WAN cloud-init file has two parts, cloud-config and cloud-boothook.

**text/cloud-config**

Contains the global parameters like uuid, token, org-name, vbond, cert etc

```
**MIME: text/cloud-config**
- Description:
- Root CA cert, viptela properties encoded in the part in YAML format and others.
     - ca-certs:
     - vinitparam
     - format-partition
     - otp
     - vbond
     - uuid
     - org
     - rcc
```

**text/cloud-boothook**

Contains the configuration of the device

```
**MIME: text/cloud-boothook**
  <Configuration of the node>
```

<br>

## cloud-config

From version 17.2, “rcc” became just a binary switch. When rcc has any values, cloud-init finds ca-certs. “rcc: 1” is enough, however by giving cert itself to rcc, it can work on previous versions as well. ca-certs can be configured in the general way of cloud-init.

[Example](https://cloudinit.readthedocs.io/en/latest/topics/examples.html)

**otp** is the one time password for cloud-vedge. Giving the chassis number as uuid and serial number as otp, vEdge boots up with those information already configured.

**vbond** is it’s vbond address, and org is Organization Name. When these are in cloud-config, vEdge is initialized with those information.

**format-partition**: 1 is specifically for vManage. With it, 2nd partition of HDD will be formatted automatically. Otherwise, VM will keep wait for user to confirm to format it and initialization stops.

<br>


## cloud-boothook

Each node has confd (Tail-F confd) inside, and it is the configuration database. Entered configuration here is imported into confd CDB when it is initialized.

<br>


## Creating Bootstrap file from vManage

Create a Device Template and attach that template to your device. Enter all parameters and deploy.

Then go to Configuration > Device > WAN Edge List

Click on the 3-dots on the right of a device and pick "Generate bootstrap configuration"

![virt-manager](img/csr1000v-kvm-09.png)

For KVM select Cloud-Init. (VMWare uses Encoded String). Then click OK.

![virt-manager](img/csr1000v-kvm-10.png)

vManage will generate a cloud-init file that contains the cloud-config and cloud-boothook parts. This file is MIME encoded and can be used to load the VM (ciscosdwan_cloud_init.cfg file) or for hardware device (ciscosdwan.cfg). This file has to be copied to the flash. 

Once downloaded, you can then tune this file according to your needs.

The cloud-init config file will need to be named ciscosdwan_cloud_init.cfg for the CSR1000v to be able to load it.

<br>


## Creating Bootstrap file using Linux tools

You can utilize “write-mime-multipart” application. It’s included in the cloud-utils package, so installation can be done in this way.

Ubuntu or Debian

```bash
# apt-get install cloud-utils
```

Redhat or CentOS

```bash
# yum install cloud-utils
```

You have to build 2 files:

+ cloud-config => cloud-config.txt
+ cloud-boothook => cloud-boothook.txt

The best option is to take a bootstrap file generated by vManage as a reference and change as required.

Example of cloud-config.txt:

```
#cloud-config
vinitparam:
 - uuid : CSR-E5E74EA5-B976-6584-CDFC-3D521AC73D24
 - vbond : 10.60.23.134
 - otp : 8c15259f59e7b815c8f272dbe58d3630
 - org : ADT Labs Paris
 - rcc : true
ca-certs:
  remove-defaults: false
  trusted:
  - |
   -----BEGIN CERTIFICATE-----
            [SNIP]
   -----END CERTIFICATE----------END CERTIFICATE-----
```

Example of cloud-boothook:

```
#cloud-boothook


viptela-system:system 
personality vedge
device-model vedge-cloud
vbond 10.60.23.134 port 12346
chassis-number CSR-E5E74EA5-B976-6584-CDFC-3D521AC73D24
ztp-status success
config-template-name "branch-vedge-single"
pseudo-confirm-commit 300
!
  viptela-system:system
   personality             vedge
   device-model            vedge-cloud
   host-name               vedge91
   system-ip               10.0.0.66
   domain-id               1
   site-id                 100
   no route-consistency-check
   sp-organization-name    "ADT Labs Paris"
   organization-name       "ADT Labs Paris"
   vbond 10.60.23.134 port 12346
   aaa
    auth-order local radius tacacs
    usergroup basic
     task system read write
     task interface read write
    !
    usergroup netadmin
    !
    usergroup operator
     task system read
     task interface read
     task policy read
     task routing read
     task security read
    !
    user admin
     password admin
    !
   !
   logging
    disk
     enable
    !
   !
  !
  omp
   no shutdown
   graceful-restart
   advertise connected
   advertise static
  !
  security
   ipsec
    authentication-type sha1-hmac ah-sha1-hmac
   !
  !
  vpn 0
   name "Transport VPN"
   interface ge0/0
    ip dhcp-client
    tunnel-interface
     encapsulation ipsec
     no allow-service bgp
     allow-service dhcp
     allow-service dns
     allow-service icmp
     allow-service sshd
     allow-service netconf
     allow-service ntp
     no allow-service ospf
     no allow-service stun
    !
    no shutdown
   !
  !
  vpn 512
   interface eth0
    ip address 10.1.1.1/24
    no shutdown
  !
 !
!
```

When you have each data in text files, you can combine them and construct a multipart text.

```bash
# write-mime-multipart --output=ciscosdwan_cloud_init.cfg cloud-config.txt:text/cloud-config cloud-boothook.txt:text/cloud-boothook
```

<br>

## To pass Bootstrap File 

As seen before, upon bootup, CSR1000v SD-WAN XE router will search for filename ciscosdwan_cloud_init.cfg, which is the cloud-init file generated by vManage (or by linux tools). We need to create an iso image that contains this file. This will be mounted as a cdrom and used by cloud-init to bootstrap de VM.

Create the iso image to pass the ciscosdwan_cloud_init.cfg bootstrap file to cloud-init : 

```bash
# mkisofs -l -o config.iso ciscosdwan_cloud_init.cfg
```

**Note**: This tool does not work:

```bash
# cloud-localds config.iso <configuration_filename>
```

This file config.iso will be used to create the CSR1000v with virt-install. The Bootstrap Configuration will be passed to the router and installed in the bootflash.


<br>

